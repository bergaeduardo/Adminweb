{% extends "layouts/base.html" %}
{% load volumen_filters %}

{% block title %} Gestión de Volúmenes de Artículos {% endblock %}

{% block stylesheets %}
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="/static/assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="/static/assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="/static/assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
{% endblock stylesheets %}

{% block content %}

<!-- Content Wrapper -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1><i class="fas fa-cube"></i> Gestión de Volúmenes de Artículos</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="#">Herramientas</a></li>
            <li class="breadcrumb-item active">Volúmenes de Artículos</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      
      <!-- Estadísticas -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card card-outline card-primary">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                Información General
              </h3>
              <div class="card-tools">
                <a href="{% url 'herramientas:eb_sinc_art_volumen_carga_masiva_form' %}" 
                   class="btn btn-primary btn-sm" title="Carga masiva desde Excel">
                  <i class="fas fa-upload"></i> Carga Masiva
                </a>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-boxes"></i></span>
                    <div class="info-box-content">
                      <span class="info-box-text">Total Artículos</span>
                      <span class="info-box-number">{{ total_articulos }}</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Información:</strong> Esta tabla gestiona las dimensiones y pesos de los artículos para cálculos de volumen y envío.
                    Los campos <strong>Código Artículo</strong>, <strong>Descripción</strong> y <strong>Rubro</strong> son de solo lectura.
                  </div>
                </div>
                <div class="col-md-3">
                  {% if search_term or filtro_estado or filtro_rubro %}
                    <div class="alert alert-warning">
                      <strong><i class="fas fa-filter"></i> Filtros Aplicados:</strong><br>
                      {% if search_term %}<small><i class="fas fa-search"></i> "{{ search_term }}"</small><br>{% endif %}
                      {% if filtro_estado %}<small><i class="fas fa-toggle-on"></i> Estado: {{ filtro_estado|title }}</small><br>{% endif %}
                      {% if filtro_rubro %}<small><i class="fas fa-tag"></i> Rubro: {{ filtro_rubro }}</small>{% endif %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla principal -->
      <div class="card card-outline card-primary">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-table"></i>
            Listado de Artículos
          </h3>
          <div class="card-tools">
            <!-- Filtros y Búsqueda -->
            <form method="GET" class="row">
              <div class="col-auto">
                <input type="text" name="search" value="{{ search_term }}" class="form-control form-control-sm" placeholder="Buscar..." style="width: 200px;">
              </div>
              <div class="col-auto">
                <select name="estado" class="form-control form-control-sm">
                  <option value="">Todos los estados</option>
                  <option value="activo" {% if filtro_estado == 'activo' %}selected{% endif %}>Activos</option>
                  <option value="inactivo" {% if filtro_estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
                </select>
              </div>
              <div class="col-auto">
                <select name="rubro" class="form-control form-control-sm">
                  <option value="">Todos los rubros</option>
                  {% for rubro in rubros_disponibles %}
                    <option value="{{ rubro }}" {% if filtro_rubro == rubro %}selected{% endif %}>{{ rubro }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-auto">
                <!-- <button type="submit" class="btn btn-primary btn-sm">
                  <i class="fas fa-search"></i> Filtrar
                </button> -->
                {% if search_term or filtro_estado or filtro_rubro %}
                  <a href="{% url 'herramientas:eb_sinc_art_volumen_list' %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-times"></i> Limpiar
                  </a>
                {% endif %}
              </div>
            </form>
          </div>
        </div>

        <div class="card-body">
          {% if page_obj %}
            <div class="table-responsive">
              <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th style="width: 120px;">Código</th>
                    <th>Descripción</th>
                    <th style="width: 120px;">Rubro</th>
                    <th class="text-center" style="width: 80px;">Estado</th>
                    <th class="text-center" style="width: 90px;">Embalaje<br><small>A×An×L (cm)</small></th>
                    <th class="text-center" style="width: 90px;">Real<br><small>A×An×L (cm)</small></th>
                    <th class="text-center" style="width: 70px;">Peso Emb.</th>
                    <th class="text-center" style="width: 70px;">Peso Real</th>
                    <th class="text-center" style="width: 120px;">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for articulo in page_obj %}
                  <tr>
                    <td>
                      <strong>{{ articulo.COD_ARTICULO }}</strong>
                    </td>
                    <td>{{ articulo.DESCRIPCION|truncatechars:40 }}</td>
                    <td>
                      {% if articulo.Rubro %}
                        <span class="badge badge-secondary">{{ articulo.Rubro }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if articulo.ESTADO %}
                        <span class="badge badge-success"><i class="fas fa-check"></i> Activo</span>
                      {% else %}
                        <span class="badge badge-danger"><i class="fas fa-times"></i> Inactivo</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if articulo.altoEmbalaje or articulo.anchoEmbalaje or articulo.largoEmbalaje %}
                        <small class="badge badge-info">
                          {{ articulo.altoEmbalaje|mm_a_cm|floatformat:1|default:'-' }}×{{ articulo.anchoEmbalaje|mm_a_cm|floatformat:1|default:'-' }}×{{ articulo.largoEmbalaje|mm_a_cm|floatformat:1|default:'-' }}
                        </small>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if articulo.altoReal or articulo.anchoReal or articulo.largoReal %}
                        <small class="badge badge-success">
                          {{ articulo.altoReal|mm_a_cm|floatformat:1|default:'-' }}×{{ articulo.anchoReal|mm_a_cm|floatformat:1|default:'-' }}×{{ articulo.largoReal|mm_a_cm|floatformat:1|default:'-' }}
                        </small>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if articulo.pesoEmbalaje %}
                        <span class="badge badge-info">{{ articulo.pesoEmbalaje }}g</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if articulo.pesoReal %}
                        <span class="badge badge-success">{{ articulo.pesoReal }}g</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="btn-group" role="group">
                        <a href="{% url 'herramientas:eb_sinc_art_volumen_detail' articulo.COD_ARTICULO %}" 
                           class="btn btn-info btn-xs" title="Ver detalles">
                          <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'herramientas:eb_sinc_art_volumen_edit' articulo.COD_ARTICULO %}" 
                           class="btn btn-warning btn-xs" title="Editar">
                          <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'herramientas:eb_sinc_art_volumen_delete' articulo.COD_ARTICULO %}" 
                           class="btn btn-danger btn-xs" title="Eliminar"
                           onclick="return confirm('¿Está seguro de que desea eliminar este artículo?');">
                          <i class="fas fa-trash"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            {% if page_obj.has_other_pages %}
              <div class="row mt-3">
                <div class="col-sm-12 col-md-5">
                  <div class="dataTables_info">
                    Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} entradas
                    {% if search_term %} (filtrado de {{ total_articulos }} entradas totales){% endif %}
                  </div>
                </div>
                <div class="col-sm-12 col-md-7">
                  <div class="dataTables_paginate paging_simple_numbers">
                    <ul class="pagination justify-content-end">
                      {% if page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?page=1{% if search_term %}&search={{ search_term }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_rubro %}&rubro={{ filtro_rubro }}{% endif %}">Primera</a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_term %}&search={{ search_term }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_rubro %}&rubro={{ filtro_rubro }}{% endif %}">Anterior</a>
                        </li>
                      {% endif %}
                      
                      <li class="page-item active">
                        <span class="page-link">
                          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                      </li>
                      
                      {% if page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_term %}&search={{ search_term }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_rubro %}&rubro={{ filtro_rubro }}{% endif %}">Siguiente</a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_term %}&search={{ search_term }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if filtro_rubro %}&rubro={{ filtro_rubro }}{% endif %}">Última</a>
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
            {% endif %}

          {% else %}
            <div class="text-center py-4">
              {% if search_term or filtro_estado or filtro_rubro %}
                <div class="alert alert-warning">
                  <i class="fas fa-search"></i>
                  No se encontraron resultados con los filtros aplicados:
                  {% if search_term %}<strong>Búsqueda:</strong> "{{ search_term }}"{% endif %}
                  {% if filtro_estado %}<strong>Estado:</strong> {{ filtro_estado|title }}{% endif %}
                  {% if filtro_rubro %}<strong>Rubro:</strong> {{ filtro_rubro }}{% endif %}
                  <br>
                  <a href="{% url 'herramientas:eb_sinc_art_volumen_list' %}" class="btn btn-primary btn-sm mt-2">
                    <i class="fas fa-list"></i> Ver todos los artículos
                  </a>
                </div>
              {% else %}
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  No hay artículos registrados en la base de datos.
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
</div>

{% endblock content %}

{% block javascripts %}
  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.min.js"></script>
  
  <script>
    $(document).ready(function() {
      // Tooltip para botones
      $('[title]').tooltip();
      
      // Auto-submit búsqueda después de 3 caracteres
      let searchTimeout;
      $('input[name="search"]').on('keyup', function() {
        clearTimeout(searchTimeout);
        const searchTerm = $(this).val();
        
        if (searchTerm.length >= 3 || searchTerm.length === 0) {
          searchTimeout = setTimeout(() => {
            $(this).closest('form').submit();
          }, 500);
        }
      });
      
      // Auto-submit cuando cambian los filtros
      $('select[name="estado"], select[name="rubro"]').on('change', function() {
        $(this).closest('form').submit();
      });
    });
  </script>
{% endblock javascripts %}