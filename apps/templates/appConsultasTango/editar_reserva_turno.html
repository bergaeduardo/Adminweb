{% extends "layouts/base.html" %}
{% load static %}

{% block body_class %}sidebar-mini sidebar-collapse{% endblock body_class %}

{% block stylesheets %}
<!-- Google Font: Source Sans Pro -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
<style>
    .card-header[data-toggle="collapse"] {
        transition: background-color 0.3s ease;
    }
    
    .card-header[data-toggle="collapse"]:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .card-header .btn-tool {
        pointer-events: none;
    }
    
    .collapse {
        transition: height 0.3s ease;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>{{ Nombre }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'herramientas:herramientas_calendario_reservas' %}">Calendario</a></li>
                        <li class="breadcrumb-item active">{{ Nombre }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="card {% if solo_lectura %}card-secondary{% else %}card-warning{% endif %}">
                        <div class="card-header">
                            <h3 class="card-title">
                                {% if solo_lectura %}
                                <i class="fas fa-eye"></i> Ver Turno #{{ turno.id_turno_reserva }}
                                {% else %}
                                <i class="fas fa-edit"></i> Editar Reserva de Turno #{{ turno.id_turno_reserva }}
                                {% endif %}
                            </h3>
                        </div>
                        
                        <!-- Información del Estado Actual -->
                        <div class="card-body bg-light border-bottom">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Estado Actual:</strong></p>
                                    <h4>
                                        <span class="badge" style="background-color: {{ turno.estado.color }}; font-size: 1.1em;">
                                            {{ turno.estado.nombre }}
                                        </span>
                                        {% if not turno.estado.permite_editar %}
                                        <span class="badge badge-danger ml-2">
                                            <i class="fas fa-lock"></i> No Editable
                                        </span>
                                        {% endif %}
                                    </h4>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Última Modificación de Estado:</strong></p>
                                    <p class="mb-0">
                                        {% if turno.estado_actual_desde %}
                                            {{ turno.estado_actual_desde|date:"d/m/Y H:i" }} 
                                            {% if turno.usuario_ultima_modificacion_estado %}
                                                por {{ turno.usuario_ultima_modificacion_estado }}
                                            {% endif %}
                                        {% else %}
                                            Sin información
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            
                            {% if solo_lectura %}
                            <div class="alert alert-info mt-3 mb-0">
                                <h5><i class="fas fa-lock"></i> Modo Solo Lectura</h5>
                                <p class="mb-0">
                                    Este turno se encuentra en estado <strong>"{{ turno.estado.nombre }}"</strong> que no permite modificaciones.
                                    <br>
                                    Los campos se muestran únicamente para consulta. No es posible editar ningún dato ni guardar cambios.
                                    <br>
                                    Si necesita realizar modificaciones, contacte al administrador del sistema.
                                </p>
                            </div>
                            {% elif turno.estado and turno.estado.nombre != 'RESERVADO' %}
                            <div class="alert alert-warning mt-3 mb-0">
                                <h5><i class="fas fa-lock"></i> Turno en Estado: {{ turno.estado.nombre }}</h5>
                                <p class="mb-0">
                                    Los campos de <strong>proveedor, fechas, horarios, remitos y cantidades</strong> no se pueden modificar cuando el turno se encuentra en estado <strong>"{{ turno.estado.nombre }}"</strong>.
                                    <br>
                                    Solo se puede cambiar el estado del turno. Para modificar otros datos, el turno debe estar en estado <strong>"RESERVADO"</strong>.
                                </p>
                            </div>
                            {% elif turno_es_pasado %}
                            <div class="alert alert-warning mt-3 mb-0">
                                <h5><i class="fas fa-exclamation-triangle"></i> Turno de Fecha Pasada</h5>
                                <p class="mb-0">
                                    Este turno corresponde al día actual o a una fecha pasada.
                                    <br>
                                    Los campos de <strong>fecha y hora</strong> no se pueden modificar.
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <form method="post">
                            {% csrf_token %}
                            <div class="card-body">

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.codigo_proveedor.id_for_label }}">Código Proveedor *</label>
                                            {% if solo_lectura or form.codigo_proveedor.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.codigo_proveedor }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="codigo_proveedor" value="{{ turno.codigo_proveedor|default:'' }}">
                                            {% else %}
                                            {{ form.codigo_proveedor }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.nombre_proveedor.id_for_label }}">Nombre Proveedor</label>
                                            {% if solo_lectura or form.nombre_proveedor.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.nombre_proveedor }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="nombre_proveedor" value="{{ turno.nombre_proveedor|default:'' }}">
                                            {% else %}
                                            {{ form.nombre_proveedor }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="{{ form.fecha.id_for_label }}">Fecha *</label>
                                            {% if solo_lectura or form.fecha.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.fecha|date:'d/m/Y' }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="fecha" value="{{ turno.fecha|date:'Y-m-d' }}">
                                            {% else %}
                                            {{ form.fecha }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="{{ form.hora_inicio.id_for_label }}">Hora Inicio *</label>
                                            {% if solo_lectura or form.hora_inicio.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.hora_inicio }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="hora_inicio" value="{{ turno.hora_inicio|time:'H:i' }}">
                                            {% else %}
                                            {{ form.hora_inicio }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="{{ form.hora_fin.id_for_label }}">Hora Fin *</label>
                                            {% if solo_lectura or form.hora_fin.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.hora_fin }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="hora_fin" value="{{ turno.hora_fin|time:'H:i' }}">
                                            {% else %}
                                            {{ form.hora_fin }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.orden_compra.id_for_label }}">Orden de Compra *</label>
                                            {% with orden_compra_formateada=turno.orden_compra|cut:"'"|cut:"["|cut:"]" %}
                                            {% if solo_lectura %}
                                            <input type="text" class="form-control" value="{{ orden_compra_formateada }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            {% else %}
                                            <input type="text" class="form-control" value="{{ orden_compra_formateada }}" readonly style="background-color: #e9ecef; cursor: not-allowed;" title="Las órdenes de compra no se pueden editar en este formulario">
                                            {% endif %}
                                            {% endwith %}
                                            <!-- Campo oculto para enviar el valor de orden_compra al formulario -->
                                            <input type="hidden" name="orden_compra" value="{{ turno.orden_compra|default:'' }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.remitos.id_for_label }}">Remitos *</label>
                                            {% if solo_lectura or form.remitos.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.remitos }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="remitos" value="{{ turno.remitos|default:'' }}">
                                            {% else %}
                                            {{ form.remitos }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.cantidad_unidades.id_for_label }}">Cantidad Unidades *</label>
                                            {% if solo_lectura or form.cantidad_unidades.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.cantidad_unidades }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="cantidad_unidades" value="{{ turno.cantidad_unidades|default:'' }}">
                                            {% else %}
                                            {{ form.cantidad_unidades }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.cantidad_bultos.id_for_label }}">Cantidad Bultos</label>
                                            {% if solo_lectura or form.cantidad_bultos.field.widget.attrs.readonly %}
                                            <input type="text" class="form-control" value="{{ turno.cantidad_bultos|default:'-' }}" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                                            <input type="hidden" name="cantidad_bultos" value="{{ turno.cantidad_bultos|default:'' }}">
                                            {% else %}
                                            {{ form.cantidad_bultos }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="{{ form.observaciones.id_for_label }}">Observaciones</label>
                                            {{ form.observaciones }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Campo Estado -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="{{ form.estado.id_for_label }}">Estado del Turno *</label>
                                            {% if solo_lectura %}
                                            <div>
                                                <span class="badge" style="background-color: {{ turno.estado.color }}; font-size: 1em; padding: 8px 12px;">
                                                    {{ turno.estado.nombre }}
                                                </span>
                                            </div>
                                            {% else %}
                                            {{ form.estado }}
                                            {% if form.estado.field.widget.attrs.disabled %}
                                                <small class="form-text text-muted">
                                                    <i class="fas fa-info-circle"></i> 
                                                    Solo usuarios Admin/Logística pueden modificar el estado.
                                                </small>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                {% if not solo_lectura and not turno.historial_estados.exists %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Nota:</strong> Los turnos deben ser en bloques de 30 minutos. 
                                    Usuarios sin permisos Admin/Logística solo pueden reservar hasta 2 bloques consecutivos (1 hora).
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-footer">
                                {% if solo_lectura %}
                                <a href="{% url 'herramientas:herramientas_calendario_reservas' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Volver al Calendario
                                </a>
                                <!-- Botón para reportar incidencia (solo lectura) -->
                                <button type="button" class="btn btn-danger float-right" data-toggle="modal" data-target="#modalIncidencia">
                                    <i class="fas fa-exclamation-triangle"></i> Reportar Incidencia
                                </button>
                                {% else %}
                                <button type="submit" class="btn btn-primary" id="btnGuardar">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                                <a href="{% url 'herramientas:herramientas_calendario_reservas' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                                <!-- Botón para reportar incidencia -->
                                <button type="button" class="btn btn-danger float-right" data-toggle="modal" data-target="#modalIncidencia">
                                    <i class="fas fa-exclamation-triangle"></i> Reportar Incidencia
                                </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>

                    <!-- Incidencias Reportadas -->
                    {% if incidencias %}
                    <div class="card card-danger mt-3">
                        <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#collapseIncidencias" aria-expanded="false" aria-controls="collapseIncidencias">
                            <h3 class="card-title">
                                <i class="fas fa-exclamation-circle"></i> Incidencias Reportadas 
                                <span class="badge badge-light ml-2">{{ incidencias.count }}</span>
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool">
                                    <i class="fas fa-chevron-down" id="iconIncidencias"></i>
                                </button>
                            </div>
                        </div>
                        <div id="collapseIncidencias" class="collapse">
                            <div class="card-body p-0">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Código</th>
                                            <th>Descripción Error</th>
                                            <th>Cantidad Afectada</th>
                                            <th>Detalle</th>
                                            <th>Usuario</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for incidencia in incidencias %}
                                        <tr {% if incidencia.resuelto %}class="table-success"{% endif %}>
                                            <td>{{ incidencia.fecha_registro|date:"d/m/Y H:i" }}</td>
                                            <td>
                                                <span class="badge badge-danger">{{ incidencia.codigo_error.CodigoError }}</span>
                                            </td>
                                            <td>{{ incidencia.codigo_error.DescripcionError }}</td>
                                            <td>{{ incidencia.cantidad_afectada|default:"-" }}</td>
                                            <td>{{ incidencia.detalle|default:"-"|truncatewords:10 }}</td>
                                            <td>{{ incidencia.usuario_registro }}</td>
                                            <td>
                                                {% if incidencia.resuelto %}
                                                    <span class="badge badge-success"><i class="fas fa-check"></i> Resuelto</span>
                                                {% else %}
                                                    <span class="badge badge-warning"><i class="fas fa-clock"></i> Pendiente</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Documentos Adjuntos -->
                    <div class="card card-primary mt-3">
                        <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#collapseAdjuntos" aria-expanded="false" aria-controls="collapseAdjuntos">
                            <h3 class="card-title">
                                <i class="fas fa-paperclip"></i> Documentos Adjuntos
                                <span class="badge badge-light ml-2" id="badgeAdjuntosCount">0</span>
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool">
                                    <i class="fas fa-chevron-down" id="iconAdjuntos"></i>
                                </button>
                            </div>
                        </div>
                        <div id="collapseAdjuntos" class="collapse">
                            <div class="card-body">
                                <!-- Info sobre límites -->
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Límites:</strong> Máximo <span id="maxArchivos">5</span> archivos por turno, cada uno hasta <span id="maxTamano">5</span>MB.
                                    <br>
                                    <strong>Formatos permitidos:</strong> Imágenes (.jpg, .png, .gif), PDF, Excel (.xlsx, .xls), CSV, Word (.doc, .docx)
                                    {% if not turno.estado or turno.estado.nombre != 'RESERVADO' %}
                                    <br><br>
                                    <span class="text-warning"><i class="fas fa-lock"></i> Solo se pueden subir/eliminar archivos cuando el turno está en estado <strong>RESERVADO</strong>.</span>
                                    {% endif %}
                                </div>

                                <!-- Botón Subir Archivo (solo si estado es RESERVADO) -->
                                {% if turno.estado and turno.estado.nombre == 'RESERVADO' %}
                                <div class="mb-3">
                                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modalSubirAdjunto" id="btnSubirAdjunto">
                                        <i class="fas fa-upload"></i> Subir Documento
                                    </button>
                                    <span class="ml-2 text-muted" id="archivosRestantesInfo"></span>
                                </div>
                                {% endif %}

                                <!-- Tabla de Adjuntos -->
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="tablaAdjuntos">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;">Vista</th>
                                                <th>Nombre del Archivo</th>
                                                <th>Tipo</th>
                                                <th>Tamaño</th>
                                                <th>Fecha Subida</th>
                                                <th>Usuario</th>
                                                <th style="width: 120px;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyAdjuntos">
                                            <!-- Se carga dinámicamente con JavaScript -->
                                            <tr id="rowSinAdjuntos">
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fas fa-folder-open fa-2x mb-2"></i><br>
                                                    No hay documentos adjuntos
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial de Estados -->
                    {% if historial_estados %}
                    <div class="card card-info mt-3">
                        <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#collapseHistorial" aria-expanded="false" aria-controls="collapseHistorial">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i> Historial de Cambios de Estado 
                                <span class="badge badge-light ml-2">{{ historial_estados.count }}</span>
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool">
                                    <i class="fas fa-chevron-down" id="iconHistorial"></i>
                                </button>
                            </div>
                        </div>
                        <div id="collapseHistorial" class="collapse">
                            <div class="card-body p-0">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Estado Anterior</th>
                                            <th>Estado Nuevo</th>
                                            <th>Usuario</th>
                                            <th>Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for registro in historial_estados %}
                                        <tr>
                                            <td>{{ registro.fecha_cambio|date:"d/m/Y H:i" }}</td>
                                            <td>
                                                {% if registro.estado_anterior %}
                                                    <span class="badge" style="background-color: {{ registro.estado_anterior.color }};">
                                                        {{ registro.estado_anterior.nombre }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge" style="background-color: {{ registro.estado_nuevo.color }};">
                                                    {{ registro.estado_nuevo.nombre }}
                                                </span>
                                            </td>
                                            <td>{{ registro.usuario }}</td>
                                            <td>{{ registro.observaciones|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Modal para Reportar Incidencia -->
<div class="modal fade" id="modalIncidencia" tabindex="-1" role="dialog" aria-labelledby="modalIncidenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white" id="modalIncidenciaLabel">
                    <i class="fas fa-exclamation-triangle"></i> Reportar Incidencia - Turno #{{ turno.id_turno_reserva }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formIncidencia" method="post" action="{% url 'herramientas:herramientas_reportar_incidencia' turno.id_turno_reserva %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Información del Turno:</strong><br>
                        Proveedor: {{ turno.codigo_proveedor }} - {{ turno.nombre_proveedor }}<br>
                        Fecha: {{ turno.fecha|date:"d/m/Y" }} | Horario: {{ turno.hora_inicio }} - {{ turno.hora_fin }}<br>
                        OC: {{ turno.orden_compra }} | Remitos: {{ turno.remitos }}
                    </div>

                    <div class="form-group">
                        <label for="id_codigo_error">Código de Error <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select name="codigo_error" id="id_codigo_error" class="form-control" required>
                                <option value="">-- Seleccione un código de error --</option>
                                {% for codigo in codigos_error %}
                                <option value="{{ codigo.CodigoError }}" data-categoria="{{ codigo.Categoria }}">
                                    [{{ codigo.CodigoError }}] {{ codigo.get_Categoria_display }} - {{ codigo.DescripcionError }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="input-group-append">
                                <a href="{% url 'herramientas:herramientas_crear_codigo_error' %}" 
                                   class="btn btn-success" 
                                   title="Crear nuevo código de error" 
                                   target="_blank">
                                    <i class="fas fa-plus"></i>
                                </a>
                            </div>
                        </div>
                        <small class="form-text text-muted">Seleccione el tipo de problema detectado</small>
                    </div>

                    <div class="form-group">
                        <label for="id_cantidad_afectada">Cantidad Afectada</label>
                        <input type="number" name="cantidad_afectada" id="id_cantidad_afectada" class="form-control" min="0" placeholder="Número de unidades afectadas">
                        <small class="form-text text-muted">Opcional: Indique cuántas unidades fueron afectadas por esta incidencia</small>
                    </div>

                    <div class="form-group">
                        <label for="id_detalle">Detalle de la Incidencia</label>
                        <textarea name="detalle" id="id_detalle" class="form-control" rows="4" placeholder="Describa en detalle la incidencia detectada..."></textarea>
                        <small class="form-text text-muted">Opcional: Proporcione información adicional que ayude a resolver la incidencia</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save"></i> Registrar Incidencia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Subir Adjunto -->
<div class="modal fade" id="modalSubirAdjunto" tabindex="-1" role="dialog" aria-labelledby="modalSubirAdjuntoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title text-white" id="modalSubirAdjuntoLabel">
                    <i class="fas fa-upload"></i> Subir Documento - Turno #{{ turno.id_turno_reserva }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formSubirAdjunto" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="id_tipo_documento">Tipo de Documento <span class="text-danger">*</span></label>
                        <select name="tipo_documento" id="id_tipo_documento" class="form-control" required>
                            <option value="REMITO">Remito</option>
                            <option value="CONSOLIDADO">Detalle Consolidado de Carga</option>
                            <option value="FACTURA">Factura</option>
                            <option value="OTRO" selected>Otro Documento</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="id_archivo">Archivo <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="id_archivo" name="archivo" required 
                                accept=".jpg,.jpeg,.png,.gif,.pdf,.xlsx,.xls,.csv,.doc,.docx">
                            <label class="custom-file-label" for="id_archivo" id="labelArchivo">Seleccionar archivo...</label>
                        </div>
                        <small class="form-text text-muted">
                            Formatos: JPG, PNG, GIF, PDF, Excel, CSV, Word (máx. 5MB)
                        </small>
                    </div>

                    <div id="previewContainer" style="display: none;" class="mt-3">
                        <label>Vista previa:</label>
                        <div class="text-center p-3 bg-light rounded">
                            <img id="previewImage" src="" alt="Vista previa" style="max-width: 100%; max-height: 200px; display: none;">
                            <div id="previewFile" style="display: none;">
                                <i class="fas fa-file fa-3x text-secondary"></i>
                                <p class="mb-0 mt-2" id="previewFileName"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success" id="btnSubirArchivo">
                        <i class="fas fa-upload"></i> Subir Archivo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Lightbox para Ver Imágenes -->
<div class="modal fade" id="modalLightbox" tabindex="-1" role="dialog" aria-labelledby="modalLightboxLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: rgba(0,0,0,0.9);">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white" id="modalLightboxLabel">
                    <i class="fas fa-image"></i> <span id="lightboxImageName"></span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="lightboxImage" src="" alt="Imagen ampliada" style="max-width: 100%; max-height: 80vh; cursor: zoom-in;" onclick="toggleZoom(this)">
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a href="" id="lightboxDownload" class="btn btn-primary" download>
                    <i class="fas fa-download"></i> Descargar
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- jQuery -->
<script src="/static/assets/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="/static/assets/js/adminlte.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Variables globales para adjuntos
var turnoId = {{ turno.id_turno_reserva }};
var puedeEditar = {% if turno.estado and turno.estado.nombre == 'RESERVADO' %}true{% else %}false{% endif %};

$(document).ready(function() {
    // Cargar adjuntos al iniciar
    cargarAdjuntos();
    
    // Mostrar mensajes Django con SweetAlert2
    {% if messages %}
        {% for message in messages %}
            Swal.fire({
                icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" or message.tags == "danger" %}error{% elif message.tags == "warning" %}warning{% else %}info{% endif %}',
                title: '{% if message.tags == "success" %}¡Éxito!{% elif message.tags == "error" or message.tags == "danger" %}Error{% elif message.tags == "warning" %}Advertencia{% else %}Información{% endif %}',
                html: '{{ message|escapejs }}',
                confirmButtonColor: '{% if message.tags == "success" %}#28a745{% elif message.tags == "error" or message.tags == "danger" %}#dc3545{% elif message.tags == "warning" %}#ffc107{% else %}#17a2b8{% endif %}',
                confirmButtonText: 'Entendido',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        {% endfor %}
    {% endif %}
    
    // Mostrar errores del formulario con SweetAlert2
    {% if form.errors and not messages %}
        let mensajesHTML = '<div style="text-align: left;"><ul style="margin: 0; padding-left: 20px;">';
        {% for field in form %}
            {% for error in field.errors %}
                mensajesHTML += '<li><strong>{{ field.label|escapejs }}:</strong> {{ error|escapejs }}</li>';
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            mensajesHTML += '<li><strong>{{ error|escapejs }}</strong></li>';
        {% endfor %}
        mensajesHTML += '</ul></div>';
        
        Swal.fire({
            icon: 'error',
            title: 'No se puede completar la operación',
            html: mensajesHTML,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Entendido',
            width: '600px'
        });
    {% endif %}
    
    // Auto-completar nombre proveedor
    $('#codigoProveedor').on('blur', function() {
        var codigo = $(this).val();
        if (codigo) {
            $.ajax({
                url: '{% url "herramientas:herramientas_get_nombre_proveedor" %}',
                data: { codigo: codigo },
                success: function(data) {
                    $('#nombreProveedor').val(data.nombre);
                }
            });
        }
    });

    {% if not solo_lectura %}
    // Detectar cambio de estado y preguntar si desea reportar incidencia
    var estadoOriginal = $('#id_estado').val();
    var estadoReservado = '{% for estado in form.estado.field.queryset %}{% if estado.nombre == "RESERVADO" %}{{ estado.id_estado }}{% endif %}{% endfor %}';
    var yaValidado = false;
    
    // Solo aplicar al formulario principal de edición de turno, NO al formulario del modal
    $('form:not(#formIncidencia)').on('submit', function(e) {
        // Si ya fue validado, permitir el envío
        if (yaValidado) {
            return true;
        }
        
        var estadoActual = $('#id_estado').val();
        
        // Si cambió el estado Y el nuevo estado NO es RESERVADO
        if (estadoActual != estadoOriginal && estadoActual != estadoReservado) {
            e.preventDefault();
            
            Swal.fire({
                title: 'Cambio de Estado Detectado',
                html: '¿Desea reportar una incidencia para este turno?<br><small class=\"text-muted\">Puede reportarla ahora o más tarde desde el botón \"Reportar Incidencia\"</small>',
                icon: 'question',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonColor: '#dc3545',
                denyButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class=\"fas fa-exclamation-triangle\"></i> Reportar Incidencia',
                denyButtonText: '<i class=\"fas fa-save\"></i> Solo Guardar',
                cancelButtonText: '<i class=\"fas fa-times\"></i> Cancelar',
                width: '500px'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Guardar primero, luego abrir modal de incidencia
                    sessionStorage.setItem('abrirModalIncidencia', 'true');
                    yaValidado = true;
                    $('form:not(#formIncidencia)').submit();
                } else if (result.isDenied) {
                    // Solo guardar sin reportar incidencia
                    yaValidado = true;
                    $('form:not(#formIncidencia)').submit();
                }
                // Si cancela, no hace nada y yaValidado sigue en false
            });
            
            return false;
        }
    });

    // Verificar si debe abrir modal de incidencia después de guardar
    if (sessionStorage.getItem('abrirModalIncidencia') === 'true') {
        sessionStorage.removeItem('abrirModalIncidencia');
        {% if not form.errors %}
            setTimeout(function() {
                $('#modalIncidencia').modal('show');
            }, 500);
        {% endif %}
    }
    {% endif %}

    // Animación de iconos de collapse
    $('#collapseIncidencias').on('show.bs.collapse', function () {
        $('#iconIncidencias').removeClass('fa-chevron-down').addClass('fa-chevron-up');
    });
    
    $('#collapseIncidencias').on('hide.bs.collapse', function () {
        $('#iconIncidencias').removeClass('fa-chevron-up').addClass('fa-chevron-down');
    });
    
    $('#collapseHistorial').on('show.bs.collapse', function () {
        $('#iconHistorial').removeClass('fa-chevron-down').addClass('fa-chevron-up');
    });
    
    $('#collapseHistorial').on('hide.bs.collapse', function () {
        $('#iconHistorial').removeClass('fa-chevron-up').addClass('fa-chevron-down');
    });

    // Manejo del formulario de incidencia
    $('#formIncidencia').on('submit', function(e) {
        e.preventDefault();
        
        var formData = $(this).serialize();
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                $('#modalIncidencia').modal('hide');
                Swal.fire({
                    icon: 'success',
                    title: '¡Incidencia Registrada!',
                    text: 'La incidencia ha sido reportada exitosamente.',
                    confirmButtonColor: '#28a745'
                }).then(() => {
                    // Recargar página para mostrar la incidencia
                    window.location.reload();
                });
            },
            error: function(xhr) {
                var errorMsg = 'Error al registrar la incidencia.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg,
                    confirmButtonColor: '#dc3545'
                });
            }
        });
    });
    
    // ===== MANEJO DE ADJUNTOS =====
    
    // Preview de archivo seleccionado
    $('#id_archivo').on('change', function() {
        var file = this.files[0];
        if (file) {
            $('#labelArchivo').text(file.name);
            $('#previewContainer').show();
            
            if (file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#previewImage').attr('src', e.target.result).show();
                    $('#previewFile').hide();
                };
                reader.readAsDataURL(file);
            } else {
                $('#previewImage').hide();
                $('#previewFile').show();
                $('#previewFileName').text(file.name);
            }
        } else {
            $('#labelArchivo').text('Seleccionar archivo...');
            $('#previewContainer').hide();
        }
    });
    
    // Subir archivo adjunto
    $('#formSubirAdjunto').on('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Verificar que el modal está visible (prevenir submits accidentales)
        if (!$('#modalSubirAdjunto').hasClass('show')) {
            console.log('Submit de adjunto cancelado: modal no visible');
            return false;
        }
        
        // Verificar que hay un archivo seleccionado
        var fileInput = $('#id_archivo')[0];
        if (!fileInput.files || fileInput.files.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Sin archivo',
                text: 'Por favor, seleccione un archivo para subir.',
                confirmButtonColor: '#ffc107'
            });
            return false;
        }
        
        var formData = new FormData();
        formData.append('archivo', fileInput.files[0]);
        formData.append('tipo_documento', $('#id_tipo_documento').val());
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        var $btn = $('#btnSubirArchivo');
        var btnOriginal = $btn.html();
        
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Subiendo...').prop('disabled', true);
        
        $.ajax({
            url: '{% url "herramientas:herramientas_subir_adjunto_turno" turno.id_turno_reserva %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $('#modalSubirAdjunto').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: '¡Archivo Subido!',
                        text: response.message,
                        confirmButtonColor: '#28a745'
                    });
                    // Limpiar formulario
                    $('#formSubirAdjunto')[0].reset();
                    $('#labelArchivo').text('Seleccionar archivo...');
                    $('#previewContainer').hide();
                    // Recargar lista de adjuntos
                    cargarAdjuntos();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.error,
                        confirmButtonColor: '#dc3545'
                    });
                }
            },
            error: function(xhr) {
                var errorMsg = 'Error al subir el archivo.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg,
                    confirmButtonColor: '#dc3545'
                });
            },
            complete: function() {
                $btn.html(btnOriginal).prop('disabled', false);
            }
        });
    });
    
    // Limpiar modal al cerrar
    $('#modalSubirAdjunto').on('hidden.bs.modal', function() {
        $('#formSubirAdjunto')[0].reset();
        $('#labelArchivo').text('Seleccionar archivo...');
        $('#previewContainer').hide();
    });
    
    // Animación de iconos de collapse para adjuntos
    $('#collapseAdjuntos').on('show.bs.collapse', function () {
        $('#iconAdjuntos').removeClass('fa-chevron-down').addClass('fa-chevron-up');
    });
    
    $('#collapseAdjuntos').on('hide.bs.collapse', function () {
        $('#iconAdjuntos').removeClass('fa-chevron-up').addClass('fa-chevron-down');
    });
});

// Función para cargar lista de adjuntos
function cargarAdjuntos() {
    $.ajax({
        url: '{% url "herramientas:herramientas_listar_adjuntos_turno" turno.id_turno_reserva %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderizarAdjuntos(response);
            }
        },
        error: function(xhr) {
            console.error('Error al cargar adjuntos:', xhr);
        }
    });
}

// Función para renderizar la tabla de adjuntos
function renderizarAdjuntos(data) {
    var $tbody = $('#tbodyAdjuntos');
    $tbody.empty();
    
    // Actualizar badge de cantidad
    $('#badgeAdjuntosCount').text(data.total);
    
    // Actualizar info de archivos restantes
    if (data.puede_subir) {
        $('#archivosRestantesInfo').text('(' + data.archivos_restantes + ' archivos disponibles)');
        if (data.archivos_restantes <= 0) {
            $('#btnSubirAdjunto').prop('disabled', true).text(' Límite alcanzado');
        } else {
            $('#btnSubirAdjunto').prop('disabled', false);
        }
    }
    
    if (data.adjuntos.length === 0) {
        $tbody.append(`
            <tr id="rowSinAdjuntos">
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-folder-open fa-2x mb-2"></i><br>
                    No hay documentos adjuntos
                </td>
            </tr>
        `);
        return;
    }
    
    data.adjuntos.forEach(function(adjunto) {
        var iconoPreview = '';
        if (adjunto.es_imagen) {
            iconoPreview = `<img src="${adjunto.url}" alt="Preview" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;" 
                            onclick="abrirLightbox('${adjunto.url}', '${adjunto.nombre}', ${adjunto.id})" title="Ver imagen">`;
        } else if (adjunto.es_pdf) {
            iconoPreview = '<i class="fas fa-file-pdf fa-2x text-danger" title="PDF"></i>';
        } else if (adjunto.nombre.match(/\.(xlsx?|csv)$/i)) {
            iconoPreview = '<i class="fas fa-file-excel fa-2x text-success" title="Excel"></i>';
        } else if (adjunto.nombre.match(/\.(docx?)$/i)) {
            iconoPreview = '<i class="fas fa-file-word fa-2x text-primary" title="Word"></i>';
        } else {
            iconoPreview = '<i class="fas fa-file fa-2x text-secondary" title="Archivo"></i>';
        }
        
        var accionesHtml = `
            <a href="/Herramientas/adjuntos_turno/descargar/${adjunto.id}/" 
               class="btn btn-sm btn-primary" title="Descargar">
                <i class="fas fa-download"></i>
            </a>
        `;
        
        // Agregar botón eliminar solo si puede_eliminar
        if (adjunto.puede_eliminar) {
            accionesHtml += `
                <button type="button" class="btn btn-sm btn-danger ml-1" 
                        onclick="confirmarEliminarAdjunto(${adjunto.id}, '${adjunto.nombre}')" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        }
        
        var row = `
            <tr data-adjunto-id="${adjunto.id}">
                <td class="text-center">${iconoPreview}</td>
                <td>${adjunto.nombre}</td>
                <td><span class="badge badge-info">${adjunto.tipo_documento}</span></td>
                <td>${adjunto.tamaño}</td>
                <td>${adjunto.fecha_subida}</td>
                <td>${adjunto.usuario}</td>
                <td>${accionesHtml}</td>
            </tr>
        `;
        
        $tbody.append(row);
    });
}

// Función para abrir lightbox de imagen
function abrirLightbox(url, nombre, adjuntoId) {
    $('#lightboxImage').attr('src', url);
    $('#lightboxImageName').text(nombre);
    // Generar URL de descarga correcta
    var downloadUrl = `/Herramientas/adjuntos_turno/descargar/${adjuntoId}/`;
    $('#lightboxDownload').attr('href', downloadUrl);
    $('#modalLightbox').modal('show');
}

// Función para toggle de zoom en lightbox
function toggleZoom(img) {
    if (img.style.transform === 'scale(1.5)') {
        img.style.transform = 'scale(1)';
        img.style.cursor = 'zoom-in';
    } else {
        img.style.transform = 'scale(1.5)';
        img.style.cursor = 'zoom-out';
    }
}

// Función para confirmar eliminación de adjunto
function confirmarEliminarAdjunto(adjuntoId, nombreArchivo) {
    Swal.fire({
        title: '¿Eliminar archivo?',
        html: `¿Está seguro de eliminar el archivo <strong>"${nombreArchivo}"</strong>?<br><small class="text-muted">Esta acción no se puede deshacer.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-trash"></i> Eliminar',
        cancelButtonText: '<i class="fas fa-times"></i> Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            eliminarAdjunto(adjuntoId);
        }
    });
}

// Función para eliminar adjunto
function eliminarAdjunto(adjuntoId) {
    $.ajax({
        url: '{% url "herramientas:herramientas_eliminar_adjunto_turno" 0 %}'.replace('0', adjuntoId),
        type: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Eliminado!',
                    text: response.message,
                    confirmButtonColor: '#28a745'
                });
                cargarAdjuntos();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.error,
                    confirmButtonColor: '#dc3545'
                });
            }
        },
        error: function(xhr) {
            var errorMsg = 'Error al eliminar el archivo.';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMsg,
                confirmButtonColor: '#dc3545'
            });
        }
    });
}
</script>
{% endblock javascripts %}
