
{% if formulario.errors  %}
    <div class="panel-footer">
        <div class="alert alert-danger">
            <strong>¡Campos requeridos!</strong><br>
            {% for err in formulario.errors %}
                <a>{{ err }}</a><br>
            {% endfor %}
        </div>
    </div>
{% endif %}	

<style>
    /* Modern, clean look enhancements without changing layout structure */
    .cont_group {
        background: #ffffff;
        border-radius: .75rem;
        box-shadow: 0 4px 14px rgba(17, 17, 26, 0.08);
        padding: 2rem 1.5rem;
    }
    #titulo {
        font-weight: 600;
        color: #344767;
        letter-spacing: .2px;
        margin-bottom: 1.25rem;
    }
    .cont_group .label_form, .cont_group .label_form_2 {
        font-weight: 600;
        color: #46566b;
    }
    .cont_group .form-control, .cont_group .custom-select {
        border-radius: .5rem !important;
        border-color: #e3e6ec;
    }
    .cont_group .form-control:focus, .cont_group .custom-select:focus {
        border-color: #8da2fb;
        box-shadow: 0 0 0 .2rem rgba(141, 162, 251, .15);
    }
    .cont_group .btn {
        border-radius: .5rem;
    }
    .cont_group .btn-success {
        box-shadow: 0 6px 12px rgba(52, 199, 89, .15);
    }
    .cont_group .btn-secondary {
        box-shadow: 0 6px 12px rgba(17, 17, 26, .06);
    }
    /* Grid de dos columnas para mejor alineación (solo dentro del contenedor del formulario) */
    .cont_group .input-group {
        display: grid;
        grid-template-columns: repeat(2, minmax(260px, 1fr));
        column-gap: 2rem;
        row-gap: 1rem;
        align-items: end;
    }
    .cont_group .input-group > div { margin-bottom: 0; }
    /* Anula márgenes heredados que desalinean la segunda columna */
    .cont_group .ml-5 { margin-left: 0 !important; }
    .cont_group textarea.form-control { min-height: 112px; }
    .span-2 { grid-column: 1 / -1; }
    @media (max-width: 768px) {
        .cont_group .input-group { grid-template-columns: 1fr; }
    }
</style>

<form enctype="multipart/form-data" method="post" class="needs-validation mt-4" autocomplete="off" novalidate>
    {% csrf_token %}
    <div class="container cont_group mt-4 mb-2 pb-2">
        
        <h2 id="titulo">Alta de sucursales</h2>
        <div class="container cont_1">


            <div class="row">
                <div>

                    <div class="form-group">
                        <div class="input-group">
                            <div>
                                <label class="label_form" for="uname">{{ formulario.nro_sucursal.label }}:</label>
                                <input 
                                    type="{{ formulario.nro_sucursal.field.widget.input_type }}" 
                                    name="{{ formulario.nro_sucursal.name }}"
                                    class="form-control soloNum"
                                    oninput="validarTextoEntrada(this, '[0-9]')" 
                                    id="{{ formulario.nro_sucursal.name }}"
                                    placeholder="{{ formulario.nro_sucursal.label }}" 
                                    required
                                    value="{{ formulario.nro_sucursal.value | default:'' }}"
                                    {{ Disabled }}>
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            <div>
                                <label class="label_form_2" for="pwd">{{ formulario.cod_client.label }}:</label>
                                <input 
                                    type="text" 
                                    id="{{ formulario.cod_client.name }}" 
                                    name="{{ formulario.cod_client.name }}"
                                    class="form-control ml-5 input_2 textNum mayusc" 
                                    autocapitalize="characters"
                                    oninput="validarTextoEntrada(this, '[0-9a-z]')" 
                                    placeholder="Ingrese código"
                                    required
                                    value="{{ formulario.cod_client.value | default:'' }}"
                                    >
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>

                            <div>
                                <label class="label_form" for="uname">{{ formulario.desc_sucursal.label }}:</label>
                                <input 
                                    type="text" 
                                    class="form-control input_1 soloText mayusc"
                                    oninput="validarTextoEntrada(this, '[a-záéíóúñ ]')" 
                                    id="{{ formulario.desc_sucursal.name }}"
                                    name="{{ formulario.desc_sucursal.name }}"
                                    placeholder="Ingrese nombre" 
                                    required
                                    value="{{ formulario.desc_sucursal.value | default:'' }}"
                                    {{ Disabled }}>
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            <div>
                                <label class="label_form_2 ml-5" for="pwd">{{ formulario.direccion.label }}:</label>
                                <input 
                                    type="text" 
                                    class="form-control ml-5 input_2 mayusc" 
                                    id="{{ formulario.direccion.name }}"
                                    name="{{ formulario.direccion.name }}"
                                    placeholder="Ingrese calle y número" 
                                    required
                                    value="{{ formulario.direccion.value | default:'' }}">
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            
                            <div>
                                <label class="label_form" for="uname">{{ formulario.localidad.label }}:</label>
                                <input 
                                    type="text" 
                                    class="form-control input_1 soloText mayusc"
                                    oninput="validarTextoEntrada(this, '[a-záéíóúñ ]')" 
                                    id="{{ formulario.localidad.name }}"
                                    name="{{ formulario.localidad.name }}"
                                    placeholder="Ingrese localidad" 
                                    required
                                    value="{{ formulario.localidad.value | default:'' }}">
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            <div>
                                <label class="label_form_2 ml-5" for="pwd">{{ formulario.provincia.label }}:</label>
                                <select 
                                    type="text" 
                                    class="custom-select  form-control ml-5" 
                                    value="" 
                                    id="{{ formulario.provincia.name }}"
                                    name="{{ formulario.provincia.name }}"
                                    required>
                                    {% if formulario.provincia.value %}
                                    <option value="{{ formulario.provincia.value }}"  selected>{{ formulario.provincia.value }}</option>
                                    {% else %}
                                    <option value="" disabled selected>- - -</option>
                                    {% endif %}
                                    <option value="BUENOS AIRES">BUENOS AIRES</option>
                                    <option value="CAPITAL FEDERAL">CAPITAL FEDERAL</option>
                                    <option value="CATAMARCA">CATAMARCA</option>
                                    <option value="CHACO">CHACO</option>
                                    <option value="CHUBUT">CHUBUT</option>
                                    <option value="CORDOBA">CORDOBA</option>
                                    <option value="CORRIENTES">CORRIENTES</option>
                                    <option value="ENTRE RIOS">ENTRE RIOS</option>
                                    <option value="FORMOSA">FORMOSA</option>
                                    <option value="JUJUY">JUJUY</option>
                                    <option value="LA PAMPA">LA PAMPA</option>
                                    <option value="LA RIOJA">LA RIOJA</option>
                                    <option value="MENDOZA">MENDOZA</option>
                                    <option value="MISIONES">MISIONES</option>
                                    <option value="NEUQUEN">NEUQUEN</option>
                                    <option value="RIO NEGRO">RIO NEGRO</option>
                                    <option value="SALTA">SALTA</option>
                                    <option value="SAN JUAN">SAN JUAN</option>
                                    <option value="SAN LUIS">SAN LUIS</option>
                                    <option value="SANTA CRUZ">SANTA CRUZ</option>
                                    <option value="SANTA FE">SANTA FE</option>
                                    <option value="SANTIAGO DEL ESTERO">SANTIAGO DEL ESTERO</option>
                                    <option value="IERRA DEL FUEGO">TIERRA DEL FUEGO</option>
                                    <option value="TUCUMAN">TUCUMAN</option>
                                    <option value="URUGUAY">URUGUAY</option>
                                </select>
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>

                            <div>
                                <label class="label_form" for="uname">{{ formulario.telefono.label }}:</label>
                                <input 
                                    type="text" 
                                    class="form-control input_1 soloNum mayusc"
                                    id="{{ formulario.telefono.name }}" 
                                    name="{{ formulario.telefono.name }}"
                                    placeholder="Ingrese numero"
                                    required
                                    value="{{ formulario.telefono.value | default:'' }}">
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            <div>
                                <label class="label_form_2 ml-5" for="{{ formulario.mail.name }}">e-{{ formulario.mail.label }}:</label>
                                <input 
                                    type="email" 
                                    class="form-control ml-5 input_2 email" 
                                    id="{{ formulario.mail.name }}" 
                                    name="{{ formulario.mail.name }}"
                                    placeholder="Ingrese direccion de correo" 
                                    required
                                    value="{{ formulario.mail.value | default:'' }}">
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>

                            <!-- Nuevo campo: e-Mail Empresa (mail_grupo_emp) como lista editable -->
                            <div>
                                <label class="label_form_2 ml-5" for="mail_grupo_emp_display">e-Mail Empresa:</label>
                                <textarea 
                                    class="form-control ml-5 input_2 email"
                                    id="mail_grupo_emp_display"
                                    rows="3"
                                    placeholder="Ingrese uno por línea o sepárelos por coma, punto y coma o espacio"></textarea>
                                <small class="form-text text-muted ml-5">Se guardará normalizado con “;”.</small>
                                <!-- Campo real que enviará el formulario -->
                                <input 
                                    type="hidden"
                                    id="{{ formulario.mail_grupo_emp.name }}"
                                    name="{{ formulario.mail_grupo_emp.name }}"
                                    value="{{ formulario.mail_grupo_emp.value | default:'' }}">
                            </div>

                            <div>
                                <label class="label_form" for="uname">{{ formulario.tipo_local.label }}:</label>
                                <select 
                                    type="text" 
                                    class="custom-select  form-control input_1" 
                                    value="" 
                                    id="{{ formulario.tipo_local.name }}"
                                    name="{{ formulario.tipo_local.name }}"
                                    required>
                                    {% if formulario.tipo_local.value %}
                                    <option value="{{ formulario.tipo_local.value }}"  selected>{{ formulario.tipo_local.value }}</option>
                                    {% else %}
                                    <option value="" disabled selected>- - -</option>
                                    {% endif %}
                                    <option value="CALLE">CALLE</option>
                                    <option value="SHOPPING">SHOPPING</option>
                                </select>
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            <div>
                                <label class="label_form_2 ml-5" for="pwd">{{ formulario.canal.label }}:</label>
                                <select 
                                    type="text" 
                                    class="custom-select  form-control ml-5" 
                                    value="" 
                                    id="{{ formulario.canal.name }}"
                                    name="{{ formulario.canal.name }}"
                                    required>
                                    {% if formulario.canal.value %}
                                    <option value="{{ formulario.canal.value }}"  selected>{{ formulario.canal.value }}</option>
                                    {% else %}
                                    <option value="" disabled selected>- - -</option>
                                    {% endif %}
                                    <option value="PROPIOS">PROPIOS</option>
                                    <option value="FRANQUICIAS">FRANQUICIAS</option>
                                    <option value="CERRADO">CERRADO</option>
                                    <option value="CENTRAL">CENTRAL</option>
                                    <option value="CENTRAL URUGUAY">CENTRAL URUGUAY</option>
                                    <option value="EXTERIOR">EXTERIOR</option>
                                </select>
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                            
                        </div>
                        <div class="input-group">
                            <div>
                                <label class="label_form" for="uname">{{ formulario.cod_deposi.label }}:</label>
                                <input 
                                    
                                    name="{{ formulario.cod_deposi.name }}"
                                    class="form-control soloNum"
                                    oninput="validarTextoEntrada(this, '[0-9]')" 
                                    id="{{ formulario.cod_deposi.name }}"
                                    placeholder="{{ formulario.cod_deposi.label }}" 
                                    required
                                    value="{{ formulario.cod_deposi.value | default:'' }}">
                            </div>
                            <div class="pb-2 ml-5 boton-check">
                                <label class="label_form">Ferreteria</label>
                                {{ navigation }}
                                <input 
                                    id="{{ formulario.empresa_ferreteria.name }}"
                                    name="{{ formulario.empresa_ferreteria.name }}"
                                    type="checkbox" 
                                    data-toggle="toggle" 
                                    data-style="ios" 
                                    data-height="10"
                                    unchecked
                                    data-on="SI" 
                                    data-off="NO"
                                    value="{{ formulario.empresa_ferreteria.value | default:'true' }}">
                                <div id="console-event"></div>
                                <label class="label_form">N° sucursal madre:</label>
                                <input 
                                    type="text" 
                                    class="form-control input_1 soloNum" 
                                    oninput="validarTextoEntrada(this, '[0-9]')"
                                    id="{{ formulario.nro_suc_madre.name }}" 
                                    name="{{ formulario.nro_suc_madre.name }}"
                                    placeholder="Ingrese número"
                                    value="{{ formulario.nro_suc_madre.value | default:'' }}"
                                    disabled>                
                            </div> 
                            <div>
                                <label class="label_form_2" for="pwd">{{ formulario.horario.label }}:</label>
                                <input 
                                    type="text" 
                                    class="form-control  input_2 mayusc" 
                                    id="{{ formulario.horario.name }}"
                                    name="{{ formulario.horario.name }}"
                                    placeholder="Ingrese dias y horarios de atencion" 
                                    required
                                    value="{{ formulario.horario.value | default:'' }}">
                            </div>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback mt-4">Este campo es obligatorio</div>
                                                      
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group form-check ml-5">
            <div class="icheck-primary d-inline">
                <input  
                    type="checkbox" 
                    name="{{ formulario.habilitado.name }}"
                    id="{{ formulario.habilitado.name }}"
                    value="{{ formulario.habilitado.value | default:'true' }}"
                    unchecked
                    >{{ formulario.habilitado.label }}
                <label for="checkboxPrimary2">
                </label>
            </div>

            <label class="form-check-label label_check">
                <input 
                    id="{{ formulario.tango.name }}"
                    name="{{ formulario.tango.name }}"
                    class="form-check-input" 
                    type="checkbox" 
                    value="{{ formulario.tango.value | default:'true' }}"
                    unchecked> {{ formulario.tango.label }}
            </label>

            <label class="form-check-label label_check">
                <input 
                    id="{{ formulario.dashboard_bi.name }}"
                    name="{{ formulario.dashboard_bi.name }}" 
                    class="form-check-input" 
                    type="checkbox"
                    value="{{ formulario.dashboard_bi.value | default:'true' }}"
                    unchecked> Dashboard PBI
                    
            </label>
            
            <label class="form-check-label label_check">
                <input 
                    id="{{ formulario.integra_vtex.name }}"
                    name="{{ formulario.integra_vtex.name }}" 
                    class="form-check-input" 
                    type="checkbox"
                    value="{{ formulario.integra_vtex.value | default:'true' }}"
                    unchecked> {{ formulario.integra_vtex.label }}
                    
            </label>
            <label class="form-check-label label_check">
                <input 
                    id="{{ formulario.retiro_expres.name }}"
                    name="{{ formulario.retiro_expres.name }}"
                    class="form-check-input retiro" 
                    type="checkbox" 
                    value="{{ formulario.retiro_expres.value}}"
                    unchecked> {{ formulario.retiro_expres.label }}
            </label>

        </div>

        <input 
            name="" 
            id="guardar" 
            class="btn btn-success btn-md" 
            type="submit" 
            value="Guardar">
            
        <a name="" id="" class="btn btn-secondary btn-md" href="/../Extras/direccionario" role="button">Cancelar</a>
    </div>
</form>




<script>
window.onload = function(){
    $(document).ready(function(){
        $(".toggle").click(function(){
            var findClass = 'toggle.btn-light.off';
            if ( $(this).is( "."+findClass ) ) {
                $("#nro_suc_madre").removeAttr("disabled");
                console.log('removeAttr')
            }else if($(this).is( ".toggle.btn-primary" ) ){            
                $("#nro_suc_madre").attr("disabled","");
                console.log('addAttr')
            }
        });
        // $(".retiro").click(function() {
        //     if ($(this).val("True")) {
        //         $(this).removeAttr("checked","");
        //         $(this).val("False");
        //         $(this).attr("unchecked","");
        //     }
        //     if ($(this).val("False")) {
        //         $(this).attr("checked","");
        //         $(this).val("True");
        //         $(this).removeAttr("unchecked","");
        //     }
        // });
        $(".retiro").change(function() {
            if ($(this).is(":checked")) {
                // El checkbox está seleccionado
                $(this).val("True");
            } else {
                // El checkbox no está seleccionado
                $(this).val("False");
            }
        });

    })
    

    // Utilidades para manejar listas de emails
    function normalizeEmails(text) {
        if (!text) return '';
        return text.split(/[\s,;]+/).filter(Boolean).join(';');
    }
    function toDisplayList(text) {
        if (!text) return '';
        return text.split(/[\s,;]+/).filter(Boolean).join('\n');
    }

    // Pre-cargar la vista de lista para e-Mail Empresa
    var hiddenMailEmpId = "{{ formulario.mail_grupo_emp.name }}";
    var rawMailEmp = $("#"+hiddenMailEmpId).val();
    $("#mail_grupo_emp_display").val(toDisplayList(rawMailEmp));

    $("#guardar").click(function(){
        // Normalizar la lista al campo hidden antes de enviar
        var displayVal = $("#mail_grupo_emp_display").val();
        $("#"+hiddenMailEmpId).val(normalizeEmails(displayVal));
        $('input:disabled').removeAttr('disabled'); 
        console.log('guardar')
    })
    var ferreteria = "{{ formulario.empresa_ferreteria.value }}"
    var tango = "{{ formulario.tango.value }}"
    var dashboard_bi = "{{ formulario.dashboard_bi.value }}"
    var habilitado = "{{ formulario.habilitado.value  }}"
    var integra_vtex = "{{ formulario.integra_vtex.value  }}"
    var retiro_expres = "{{ formulario.retiro_expres.value  }}"
    
    if(tango==true || tango!="None"){
        var id = "{{ formulario.tango.name }}"
        $("#"+id).removeAttr("unchecked");
        $("#"+id).attr("checked","");
    }
    if(dashboard_bi==true || dashboard_bi!="None"){
        var id = "{{ formulario.dashboard_bi.name }}"
        $("#"+id).removeAttr("unchecked");
        $("#"+id).attr("checked","");
    }
    if(habilitado==true || habilitado!="None"){
        var id = "{{ formulario.habilitado.name }}"
        $("#"+id).removeAttr("unchecked");
        $("#"+id).attr("checked","");
    }
    if(integra_vtex==true || integra_vtex!="None"){
        var id = "{{ formulario.integra_vtex.name }}"
        $("#"+id).removeAttr("unchecked");
        $("#"+id).attr("checked","");
    }
    console.log('Retiro: ' + retiro_expres)
    if(retiro_expres=='True'){
        var id = "{{ formulario.retiro_expres.name }}"
        console.log('id: ' + id)
        $("#"+id).removeAttr("unchecked");
        $("#"+id).attr("checked","");
    }

    if(ferreteria==true || ferreteria!="None"){
            $(".toggle").removeClass("btn-light off");
            $(".toggle").addClass("btn-primary");
            $(".toggle").attr("value","true");
            $("#nro_suc_madre").removeAttr("disabled");
            
        }
};


function toggleOn() {
    console.log(document.getElementById('toggle-state').checked)
    
};


</script>
